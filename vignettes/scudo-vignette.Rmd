---
title: "SCUDO: Signature-based Clustering for Diagnostic Purposes"
date: "`r Sys.Date()`"
author:
- name: Matteo Ciciani
  affiliation: &aff CIBIO, Univ. of Trento, Trento, Italy
- name: Thomas Cantore
  affiliation: *aff
output:
    BiocStyle::html_document:
        toc_float: true
vignette: >
  %\VignetteIndexEntry{SCUDO: Signature-based Clustering for Diagnostic Purposes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
abstract: This package implements in R the SCUDO pipeline proposed in Lauria (2013) and Lauria, Moyseos, Priami (2015).
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# An introduction to the method

SCUDO is a method for the analysis of gene expression profiles for diagnostic and classification purposes. The method is based on the idea of a sample-specific gene signatures. The expected result is the emergence of a partitioning of the set of samples in separate clusters (propely, communities) on the basis of signature similarity.

First, normalization and feature selection are optionally performed. Feature selection is carried out through a Wilcoxon rank sum test or through a Kruskal-Wallis rank sum test depending on the number of groups considered.

The subsequent operations include single sample gene ranking and the extraction of signatures form up-regulated and down-regulated genes. The sizes of the signatures are customizable. An all-to-all distance matrix is then computed using a metric similar to the Gene Set Enrichment Analysis (GSEA): the distance between two samples is computed as the mean of the enrichment scores (ES) of the signature of each sample in the expression profile of the other sample. Consensus signtures are then computed, both for up- and down-regulated genes and for each group. This provides a list of interesting genes of each group.

Finally, a user-defined threshold N is used to generate a network of samples. The distance matrix is treated as an adjacency matrix, but only the distances that fall below the N^th^ percentile of distances are used to draw arcs in the network. The network can be displayed in R or using Cytoscape. 

# Worked Example

Example using the `r Biocpkg("ALL")` package, containing data of T- and B-cell Acute Lymphocytic Leukemia.

## Load required packages and explore data

```{r, message=FALSE}
library(scudo)
library(ALL)
data(ALL)
```

We can extract the expression data and the samples annotation.

```{r}
expData <- exprs(ALL)
dim(expData)
phenoData <- pData(ALL)
```

`expData` contains mRNA expression measurements for 128 samples and 12625 features. The factor `phenoData$BT` classifies the samples as B- or T-cell lymphocytic leukemia:

```{r}
summary(phenoData$BT)
```

We can see that there are different classes of B- and T-cell leukemia. For now we can simplify this, keeping only the distinction between B- and T-cells.

```{r}
bt <- as.factor(stringr::str_extract(phenoData$BT, "^."))
summary(bt)
```

We can divide this dataset in a training set and a testing set. We also convert them to data.farmes. Rigth now the input to our function has to be a data.frame, but we will soon add matrices and ExpressionSets.

```{r}
inTrain <- c(1:47, 96:112)
train <- as.data.frame(expData[, inTrain])
test <- as.data.frame(expData[, -inTrain])
```



## Analyze training set

```{r}
ScudoTrain <- scudo(train, groups = bt[inTrain], nTop = 100, nBottom = 100, pValue = 0.1)
ScudoTrain
```

From this object we can extract the signatures for each sample and the consensus signatures for each group.

```{r}
UpSig <- upSignatures(ScudoTrain)
UpSig[1:5,1:5]
ConsUpSig <- consensusUpSignatures(ScudoTrain)
ConsUpSig[1:5, ]
```

The object `ScudoRes` can be used to generate a network of samples, as an `r CRANpkg("igraph")`object, using the function `ScudoNetwork`.

```{r}
netTrain <- scudoNetwork(ScudoTrain, N = 0.3)
```

The parameter `N` controls the percentage of edges to keep in the network. We can plot this network using the usual `plot` function.

```{r}
plot(netTrain)
```

This plot is useful to have a quick look at the network, but is rather ugly. We can render the network in Cytoscape, using the function `ScudoCytoscape`. Note that Cytoscape has to be open when running the function.

```{r, eval=FALSE}
scudoCytoscape(netTrain)
```

## Community clustering

We can use a community clustering algorithm to identify clusters of samples. In the following example we use the function `cluster_fast_greedy` to perform a greedy clustering of our network. In Cytoscape we can perform a similar analysis using the GLay clustering function from the clusterMaker app.

```{r,warning=FALSE}
clusterTrain <- igraph::cluster_fast_greedy(netTrain)
plot(clusterTrain, netTrain)
```

## Analyse testing set

We can use a `ScudoResults` object and the function `scudoPredict` to analyze the testing set. The feature selection is not performed in the testing set. Instead, only the features selected in the training are used in the analysis of the testing set.

```{r}
ScudoTest <- scudoPredict(ScudoTrain, test, bt[-inTrain], nTop = 100, nBottom = 100)
ScudoTest
```

We can plot the resulting network and we can attempt to identify communities.

```{r}
netTest <- scudoNetwork(ScudoTest, N = 0.3)
plot(netTest)
```

The groups are already well partitioned. We can nonetheless perform the community clustering.

```{r,warning=FALSE}
clusterTest <- igraph::cluster_fast_greedy(netTest)
plot(clusterTest, netTest)
```

The same analysis could be performed in Cytoscape.

```{r,eval=FALSE}
scudoCytoscape(netTest)
```


# References

Mario Lauria. Rank-based transcriptional signatures. Systems Biomedicine. 2013; 1(4):228-239.

Mario Lauria, Petros Moyseos and Corrado Priami. SCUDO: a tool for signature-based clustering of expression profiles. Nucleic Acids Research. 2015; 43(W1):W188-92.

